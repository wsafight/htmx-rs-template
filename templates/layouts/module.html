<!doctype html>
<html lang="zh-CN" class="h-100">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>HTMX + Rust SPA</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
            rel="stylesheet"
        />

        <!-- HTMX -->
        <script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>
        <!-- Morphdom for efficient DOM updates -->
        <script src="https://unpkg.com/morphdom@2.7.4/dist/morphdom-umd.min.js"></script>
        <!-- CountUp.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.8.0/countUp.umd.min.js"></script>

        <!-- 自定义样式 -->
        <link rel="stylesheet" href="/static/css/style.css" />

        <style>
            /* Bootstrap 自定义配置 */
            :root {
                --bs-primary-rgb: 59, 130, 246;
                --primary-color: #3b82f6;
            }

            /* 确保页面占满全屏 */
            html,
            body {
                height: 100%;
            }

            /* Flexbox 布局让页脚置底 */
            body {
                display: flex;
                flex-direction: column;
            }

            /* 主内容区域自动扩展 */
            #main-content-wrapper {
                flex: 1 0 auto;
            }

            /* 页脚固定在底部 */
            footer {
                flex-shrink: 0;
            }
        </style>
    </head>
    <body hx-boost="true" class="bg-light d-flex flex-column">
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
            <div class="container">
                <a class="navbar-brand fw-bold" href="/" hx-boost="false">
                    <i class="bi bi-rocket-takeoff me-2"></i>
                    HTMX + Rust SPA
                </a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a
                                href="/app/todos"
                                hx-get="/block/todos"
                                hx-target="#main-content"
                                hx-swap="innerHTML swap:300ms"
                                hx-push-url="/app/todos"
                                class="nav-link nav-link-custom"
                                data-page="/app/todos"
                            >
                                <i class="bi bi-check-square me-1"></i>待办事项
                            </a>
                        </li>
                        <li class="nav-item">
                            <a
                                href="/app/users"
                                hx-get="/block/users"
                                hx-target="#main-content"
                                hx-swap="innerHTML swap:300ms"
                                hx-push-url="/app/users"
                                class="nav-link nav-link-custom"
                                data-page="/app/users"
                            >
                                <i class="bi bi-people me-1"></i>用户列表
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- 主内容区域包装器 -->
        <div id="main-content-wrapper" class="flex-fill">
            <main class="container my-4" id="main-content">
                {% block content %}{% endblock %}
            </main>
        </div>

        <!-- 页脚 -->
        <include src="../blocks/footer.html"></include>

        <!-- 模态框容器 -->
        <div id="modal-container"></div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

        <!-- 导航高亮脚本 -->
        <script>
            // 高亮当前页面的导航链接
            function updateActiveNav() {
                const currentPath = window.location.pathname;
                document
                    .querySelectorAll(".nav-link-custom")
                    .forEach((link) => {
                        if (link.getAttribute("data-page") === currentPath) {
                            link.classList.add("active");
                        } else {
                            link.classList.remove("active");
                        }
                    });
            }

            // 页面切换后更新
            document.body.addEventListener("htmx:afterSwap", function (evt) {
                if (evt.detail.target.id === "main-content") {
                    updateActiveNav();
                    // 关闭移动端菜单
                    const navCollapse = document.getElementById("navbarNav");
                    if (navCollapse && navCollapse.classList.contains("show")) {
                        bootstrap.Collapse.getInstance(navCollapse).hide();
                    }
                }

                // 统计数字动画
                ["total-count", "completed-count", "pending-count"].forEach(
                    (id) => {
                        const el = document.getElementById(id);
                        if (el && el.dataset.count) {
                            const currentText = el.textContent.trim();
                            const newValue = parseInt(el.dataset.count);
                            const oldValue = parseInt(currentText) || 0;

                            if (
                                oldValue !== newValue &&
                                typeof countUp !== "undefined"
                            ) {
                                el.textContent = oldValue;
                                const counter = new countUp.CountUp(
                                    id,
                                    newValue,
                                    {
                                        startVal: oldValue,
                                        duration: 0.8,
                                    },
                                );
                                counter.start();
                            }
                        }
                    },
                );
            });

            // 页面加载时设置
            window.addEventListener("DOMContentLoaded", updateActiveNav);
        </script>
    </body>
</html>
